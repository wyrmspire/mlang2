# MLang2 System Documentation for Agents

This document provides a comprehensive overview of the MLang2 trading system, its architecture, and the workflows for developing, training, and simulating trading strategies.

## 1. System Overview

MLang2 is a machine learning-based trading platform designed for:
1.  **Scanning**: Identifying potential trade setups in market data.
2.  **Ingestion**: converting setups into structured, sharded datasets for ML training.
3.  **Training**: Training deep learning models (CNN Fusion) to predict trade outcomes.
4.  **Simulation/Replay**: Validating models visually by replaying history with real model inference.

### Key Components
-   **Backend**: FastAPI server (`src/server/main.py`) handling market data serving and replay orchestration.
-   **Frontend**: React+Vite application (`src/App.tsx`) for visualization and control.
-   **Pipeline**: `src/features/` and `src/models/` implementing the causal inference engine.

---

## 2. Core Workflows

### A. The "Scan-Train-Replay" Loop
This is the primary development cycle for new strategies.

#### 1. Scan for Setups
Generate candidate trades based on rule-based logic (e.g., Swing Breakout).
```bash
# Output: results/records.jsonl
python scripts/run_swing_breakout_scan.py
```

#### 2. Ingest Data
Convert the raw scan records into optimized Parquet shards for PyTorch.
```bash
# Input: results/records.jsonl -> Output: data/shards/
python scripts/ingest_scan_records.py
```

#### 3. Train Model
Train the FusionModel (Price Encoder + Feature MLP) on the sharded data.
```bash
# Input: data/shards/ -> Output: models/swing_breakout_model.pth
python scripts/train_from_shards.py
```

#### 4. Visual Replay
Launch the UI to verify the model's performance on the chart.
```bash
./start.sh
```
*In the UI:*
1.  Click **Simulate**.
2.  The system **prefetches** model decisions for the selected period.
3.  The chart plays back locally, overlaying real model triggers on the historical price action.

---

## 3. Architecture Details

### Hybrid Replay Engine (`SimulationView.tsx`)
We use a hybrid approach to ensure smooth visualization and accurate inference:
1.  **Backend Inference**: When replay starts, the frontend requests a "Replay Session" from the backend.
2.  **Streaming Prefetch**: The backend (`run_replay.py`) processes the requested week(s) at max speed and streams `DECISION` events to the frontend via HTTP/Fetch.
3.  **Local Playback**: The frontend buffers these decisions and then starts a client-side `setInterval` loop to render the chart bars and overlay the triggers synchronously.
4.  **Benefits**: Eliminates network lag during playback, ensures 100% frame rate, and allows "fast forwarding".

### Causal Inference (`run_replay.py`)
To ensure the model is valid for Live Trading, the pipeline is strictly causal:
-   **MarketStepper**: Feeds data one bar at a time.
-   **Local Normalization**: Features are computed and normalized using *only* the lookback window available at time `t`. Global statistics are NOT used.
-   **No Future Peeking**: The architecture guarantees that the model sees exactly what it would see in a live trading environment.

### Live Trading Readiness
To move to Live Trading:
1.  Replace the `load_continuous_contract` source with a **Live Data Feed** (e.g., IBKR/YFinance WebSocket).
2.  Feed incoming bars into the *same* `MarketStepper` -> `compute_features` -> `model.predict` pipeline.
3.  The `FusionModel` accepts tensors representing the current state and returns a probability score.

---

## 4. Key Scripts Reference

| Script | Purpose | Key Arguments |
| :--- | :--- | :--- |
| `scripts/run_replay.py` | Runs model inference on historical data. | `--model`, `--start-date`, `--threshold`, `--speed` |
| `scripts/run_modular_strategy.py` | Runs rule-based strategies (Backtest mode). | `--scan`, `--mode replay` |
| `src/server/main.py` | Main FastAPI entry point. | N/A (Run via uvicorn/start.sh) |
| `src/api/client.ts` | Frontend API layer. | `startReplay`, `getReplayStreamUrl` |

## 5. Troubleshooting

-   **Frontend Connection**: If `EventSource` fails, the `SimulationView` uses `fetch` with `ReadableStream` as a robust fallback.
-   **No Triggers**: Check the `threshold` parameter in `startReplay`. Lower it (e.g., 0.2) to see if the model is outputting low-confidence signals.
-   **Python Path**: Always run scripts from the project root (`c:\mlang2`) or set `PYTHONPATH=.`.

---

*Generated by Antigravity Agent - 2025-12-19*
